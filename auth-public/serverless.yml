app: e-signatures
org: maplighttech
service: backend-auth-public

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs14.x
  stage: ${opt:stage, "dev"}

resources:
  Resources:
    # The identity pool that will be used to link roles to
    # entities. Particularly for allowing unauthenticated access
    # to parts of the API. 
    UserIdentityPool:
      Type: "AWS::Cognito::IdentityPool"
      Properties:
        IdentityPoolName: ${self:provider.stage}-IdentityPool
        AllowUnauthenticatedIdentities: true
        CognitoIdentityProviders:
          - ClientId: ${output:backend-auth.UserPooClientId}
            ProviderName: ${output:backend-auth.UserPoolProviderName}
            ServerSideTokenCheck: true

    # The role that will allow public access to API endpoints
    PublicAccessRole:
      Type: "AWS::IAM::Role"
      Properties:
        RoleName: ${self:provider.stage}-APIPublicAccessRole
        Policies:
          - PolicyName: ${self:provider.stage}-APIPublicAccessPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                # Allow calling select queries
                - Effect: Allow
                  Action:
                    - appsync:GraphQL
                  Resource:
                    - { Fn::Join: ["/", ["${output:backend-api.ApiId}", "types/*/fields/public*"]] }


outputs:
  UserIdentityPoolId: { Ref: UserIdentityPool }
